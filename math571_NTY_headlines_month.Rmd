---
title: "Math571_project"
output: html_document
---

# Getting NYT headlines
```{r}
library(jsonlite)
library(magrittr)
library(tidyverse)
library(lubridate)
library(httr)
library(stringr)
options(max.print=20)

cristobal_key <- "5b4e1b897deb448caa65b58d6c5941ab" # Please use your own API key. you can get it from nyt api website.
#with this command I can get the historic data from a complete month
year<-1990 #not necessary with the for loop
month<-1 #not necessary with the for loop

#obsolete code
#nyt.df<-data.frame(main=character() ,kicker=character(),section_name=character(),
#                   pub_date= character())

for (year in c(2007:2010)){
        #I create the empty data frame for the headlines
        nyt.df<-data.frame()
        for (month in c(1:12)){
        
                url.nyt.archive<-paste0("https://api.nytimes.com/svc/archive/v1/",year,"/"  
                                        ,month,".json","?api-key=",cristobal_key)
                df.json<-fromJSON(url.nyt.archive)
                
                #I extract the headlines from the json file
                #headlines<-df.json$response$docs$headline #use this until 2005

                
                
                #The structure of df.json$response$docs$headline changes in 1995-03 
                #(a new column appears)so we need the following line to make it consistent
                #Until 2005 use the following line
                #headlines<-df.json$response$docs$headline[1:2]
                
                #the structure changes again, as of 2006 use the following lines
                list.processed<-sapply(df.json$response$docs$headline,
                                       function(l) c(l$main,l$kicker)[1:2])
                headlines<-plyr::ldply(list.processed, rbind)
                dims<-sapply(list.processed,FUN = length)
                missing.headlines<-which(dims!=2)
                section<-df.json$response$docs$section_name[-missing.headlines]
                date.pub<-ymd_hms(df.json$response$docs$pub_date)[-missing.headlines]
                #I extract the date and section name and add it to the data frame
                
                headlines<-cbind(headlines,section, date.pub)
                
                colnames(headlines)<-c("main","kicker","section_name","pub_date")
                #the following 2 lines are to store the section and date as character
                #in de data frame instead as a factor
                headlines$section_name<-as.character(headlines$section_name)
                headlines$pub_date<-as.character(headlines$pub_date)
                nyt.df<-rbind(nyt.df,headlines)
                print(c(year,month))
        }
        #I identify the headlines from the "Business" category
        bus.indexes<-str_detect(nyt.df$section_name, "Business")
        bus.indexes[is.na(bus.indexes)]<-F
        #I create a subset of the data frame with only the business headlines
        nyt.df.bus<-nyt.df[bus.indexes,]
        
        write.csv(nyt.df,paste0("data/nyt_headlines_",year,".csv"))
        write.csv(nyt.df.bus,paste0("data/nyt_headlines_bus_",year,".csv"))
        
        #test print
        print(missing.headlines)
        
}



```

```{r}
#testing chunk
table(nyt.df.bus$pub_date)
df.json$response$docs$headline$main[1]
df.json$response$docs$headline[1,]
head(df.json$response$docs$headline)
as.data.frame(unlist(df.json$response$docs$headline))
head(plyr::ldply(df.json$response$docs$headline, rbind))
str(df.json$response$docs$headline)

list.processed<-sapply(df.json$response$docs$headline,function(l) c(l$main,l$kicker)[1:2])
plyr::ldply(list.processed, rbind)
dims<-sapply(list.processed,FUN = length)
list.processed[which(dims!=2)]
df.json$response$docs$headline[which(dims!=2)]
df.json$response$docs$headline[1]
as.data.frame(list.processed)
section<-df.json$response$docs$section_name
section[1232]
df.json$response$docs$headline[1232]

```

```{r}
#This chunk is just to check how many API requests I have left
url.get<-paste0("https://api.nytimes.com/svc/archive/v1/",year,"/",month,".json","?api-key=",cristobal_key)
get.json<-GET(url.get)
get.json$headers[24:27]

```

