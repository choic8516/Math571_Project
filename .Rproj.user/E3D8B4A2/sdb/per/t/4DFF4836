{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Math571_project\"\noutput: html_document\n---\n\n# Getting NYT headlines\n```{r}\nlibrary(jsonlite)\nlibrary(magrittr)\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(httr)\nlibrary(stringr)\noptions(max.print=100)\n\nnyt.API.key <-\"5b4e1b897deb448caa65b58d6c5941ab\"  # Insert API key here\nyear<-1990 #not necessary with the for loop\nmonth<-1 #not necessary with the for loop\n\n```\n\n```{r}\nds.used<-character()\n\n\nfor (year in c(2017:2017)){\n        #I create the empty data frame for the headlines\n        nyt.df<-data.frame()\n        for (month in c(1:12)){\n        \n                url.nyt.archive<-paste0(\"https://api.nytimes.com/svc/archive/v1/\",year,\"/\"  \n                                        ,month,\".json\",\"?api-key=\",nyt.API.key)\n                df.json<-fromJSON(url.nyt.archive)\n                \n                #I extract the headlines from the json file\n                #headlines<-df.json$response$docs$headline #use this until 2005\n                \n                #The structure of df.json$response$docs$headline changes in 1995-03 \n                #(a new column appears)so we need the following line to make it consistent\n                #Until 2005 use the following lines\n                headlines<-df.json$response$docs$headline[1:2]\n                \n                \n                #As of 2006 the structure of the data follows an irregular pattern\n                #some months the headlines are presented as data frame\n                #and other months as nested lists. So we need the following conditional\n                #structure to deal with different data types\n                head.class<-class(headlines)\n                if (head.class==\"data.frame\"){\n                section<-df.json$response$docs$section_name\n                \n                ifelse(year==2017&(month==2|month>=8),#month %in% c(\"2\",\"8\",\"9\",\"10\",\"11\",\"12\")\n                news.desk<-df.json$response$docs$new_desk,\n                news.desk<-df.json$response$docs$news_desk)\n                length(df.json$response$docs$new_desk)\n                #class(df.json$response$docs$new_desk)\n                date.pub<-ymd_hms(df.json$response$docs$pub_date)\n                }\n                \n\n                if (head.class==\"list\"){\n                list.processed<-sapply(df.json$response$docs$headline,\n                                       function(l) c(l$main,l$kicker)[1:2])\n                headlines<-plyr::ldply(list.processed, rbind)\n                dims<-sapply(list.processed,FUN = length)\n                missing.headlines<-which(dims!=2)\n                section<-df.json$response$docs$section_name[-missing.headlines]\n                date.pub<-ymd_hms(df.json$response$docs$pub_date)[-missing.headlines]\n                news.desk<-df.json$response$docs$news_desk[-missing.headlines]\n                }\n                \n                #I want to keep track of the data structures used\n                ds.used<-c(ds.used,paste0(year,\"-\",month,\" \",head.class))\n                \n                #I extract the date and section name and add it to the data frame\n                \n                headlines<-cbind(headlines,section, date.pub,news.desk)\n                \n                colnames(headlines)<-c(\"main\",\"kicker\",\"section_name\",\"pub_date\",\"news_desks\")\n                #the following 2 lines are to store the section and date as character\n                #in de data frame instead as a factor\n                headlines$section_name<-as.character(headlines$section_name)\n                headlines$pub_date<-substr(as.character(headlines$pub_date),1,10)\n                nyt.df<-rbind(nyt.df,headlines)\n                log.data<-c(year,month,head.class,length(headlines$pub_date))\n                print(log.data)\n                write(paste(year,month,head.class,length(headlines$pub_date),format(Sys.time()\n                        , \"%Y-%m-%d %H:%M\")),\"data_test/data_log.txt\",append = T)\n        }\n        #I identify the headlines from the \"Business\" category\n        bus.indexes1<-str_detect(tolower(nyt.df$section_name), \"business\")\n        bus.indexes1[is.na(bus.indexes1)]<-F\n        bus.indexes2<-str_detect(tolower(nyt.df$news_desk), \"(business|financial)\")\n        bus.indexes2[is.na(bus.indexes2)]<-F\n        bus.indexes3<-str_detect(tolower(nyt.df$kicker), \"(business|financial)\")\n        bus.indexes3[is.na(bus.indexes3)]<-F\n        bus.indexes<-bus.indexes1 | bus.indexes2 | bus.indexes3\n        #I create a subset of the data frame with only the business headlines\n        nyt.df.bus<-nyt.df[bus.indexes,]\n        \n        write.csv(nyt.df,paste0(\"data_test/nyt_headlines_\",year,\".csv\"))\n        write.csv(nyt.df.bus,paste0(\"data_test/nyt_headlines_bus_\",year,\".csv\"))\n        \n\n}\n\n```\n\n```{r}\n#This chunk is just to check how many API requests I have left\nurl.get<-paste0(\"https://api.nytimes.com/svc/archive/v1/\",year,\"/\",month,\".json\",\"?api-key=\",nyt.API.key)\nurl.get2<-paste0(\"http://api.nytimes.com/svc/search/v2/articlesearch.json?begin_date=\",\n        \"20100305\",\"&end_date=\",\"20100306\",\"&api-key=\",nyt.API.key,\"&page=0\")\nget.json1<-GET(url.get)\nget.json2<-GET(url.get2)\nget.json1$headers[24:27]\nget.json2$headers[6:10]\n```\n```{r}\ndata.frame(df.json$response)\n\n```\n\n```{r}\n#testing chunck\ndf.old<-read.csv(\"data/nyt_headlines_bus_2010.csv\")\ndf.new<-read.csv(\"data_test/nyt_headlines_2010.csv\")\ndf.complete<-read.csv(\"data/nyt_headlines_2010.csv\")\ndf.old$pub_date<-substr(df.old$pub_date,1,10)\ndf.complete$pub_date<-substr(df.complete$pub_date,1,10)\n\ndf.old[str_detect(df.old$pub_date,\"2010-03-0(5|6|7)\"),2]\ndf.new[str_detect(df.new$main,\"(?=Apple)\"),c(2,5)]\ndf.new[str_detect(df.new$main,\"(?=.*Apple)(?=.*iPad)\"),c(2,5)]\ndf.complete[str_detect(df.complete$main,\"(?=.*Apple)(?=.*Selling)\"),c(2,5)]\ndf.new[str_detect(df.new$main,\"(?=.*Apple)\"),c(2,5)]\ndf.complete[str_detect(df.complete$main,\"^Apple\"),c(2,5)]\ndf.new[df.new$pub_date==\"2010-03-05\",]\n\nmail.nyt<-headlines[str_detect(headlines$pub_date,\"2010-03-0(5|6|7)\"),]\nrownames(mail.nyt)<-c()\nwrite.csv(mail.nyt[c(1,4)],\"2010-03-0567-archive.csv\")\n```\n\n\n```{r}\n\n\n\n\n#testing chunk\n#2004 ok\n#2007 sort of ok\ndim(df.json$response$docs)\ndf.json$response$docs$headline\nunlist(df.json$response$docs$keywords)\ntable(nyt.df$section_name)\nunname(sort(table(nyt.df.bus$pub_date)))\nindexes<-which(bus.indexes)\ntryThis[bus.indexes]\nnyt.df$section_name[1:100]\nstr(df.json$response$docs$headline)\ndf.json$response$docs$snippet[1]\na<-df.json$response$meta\nfile.size(a)\n```\n\n\n\n```{r}\n#testing chunk\nlibrary(curl)\nmyURL<-function(year,month){\n\nurl.nyt.archive<-paste0(\"https://api.nytimes.com/svc/archive/v1/\",year,\"/\"  \n                                        ,month,\".json\",\"?api-key=\",cristobal_key)\nreturn(url.nyt.archive)\n}\n\nurl.nyt.archive<-myURL(2007,1)\ndf.json1<-fromJSON(url.nyt.archive,flatten = T)\n#str(df.json$response$docs$headline)\n\nurl.nyt.archive<-myURL(2007,11)\ndf.json2<-fromJSON(url.nyt.archive)\n\n\n\nclass(df.json1$response$docs$headline)\nclass(df.json2$response$docs$headline)\n```\n\n\n",
    "created" : 1522167890744.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4256923507",
    "id" : "4DFF4836",
    "lastKnownWriteTime" : 1522213901,
    "last_content_update" : 1522213901268,
    "path" : "C:/OneDrive/2018/_MATH571/Math571_Project/nyt_scraping_archive.Rmd",
    "project_path" : "nyt_scraping_archive.Rmd",
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}